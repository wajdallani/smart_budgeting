{% extends "admin/change_form.html" %}
{% load static i18n %}

{% block content_title %}{% endblock %}

{% block extrahead %}
{{ block.super }}

<link rel="stylesheet" href="{% static 'vendor/css/core.css' %}">
<link rel="stylesheet" href="{% static 'vendor/css/theme-default.css' %}">
<link rel="stylesheet" href="{% static 'css/demo.css' %}">
<link rel="stylesheet" href="{% static 'vendor/libs/perfect-scrollbar/perfect-scrollbar.css' %}">
<link rel="stylesheet" href="{% static 'vendor/fonts/boxicons.css' %}">

<style>
    #header,
    #nav-sidebar,
    .breadcrumbs,
    #toggle-nav-sidebar {
        display: none !important;
    }

    body {
        margin: 0 !important;
        padding: 0 !important;
        background: #f5f5f9;
        font-family: 'Public Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    #content {
        margin: 0 !important;
        padding: 0 !important;
    }

    .layout-wrapper {
        display: flex;
        min-height: 100vh;
        width: 100%;
    }

    .layout-container {
        display: flex;
        flex: 1;
    }

    .layout-page {
        display: flex;
        flex-direction: column;
        flex: 1;
        margin-left: 1.5rem;
        margin-right: 1.5rem;
    }

    .content-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 2rem 0;
    }

    .content-inner {
        max-width: 1440px;
        width: 100%;
        margin: 0 auto;
        padding: 0 1rem;
    }

    .page-header {
        margin-bottom: 2rem;
    }

    .page-header h4 {
        font-weight: 600;
        color: #566a7f;
        margin-bottom: 0.5rem;
        font-size: 1.5rem;
    }

    .page-header p {
        color: #a1acb8;
        margin: 0;
        font-size: 0.9375rem;
    }

    .form-container {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 6px rgba(67, 89, 113, 0.12);
        overflow: hidden;
        animation: slideIn 0.4s ease;
    }

    .form-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2rem;
        color: white;
    }

    .form-header h2 {
        margin: 0 0 0.5rem 0;
        font-size: 1.75rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .form-header h2 i {
        font-size: 2rem;
    }

    .form-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 0.9375rem;
    }

    .form-content {
        padding: 2rem;
    }

    .form-content > h1,
    .form-content > .breadcrumbs {
        display: none !important;
    }

    fieldset.module {
        background: transparent;
        border: none;
        padding: 0;
        margin-bottom: 2rem;
    }

    fieldset.module h2 {
        background: #f8f9fa;
        color: #566a7f;
        padding: 1rem 1.25rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        font-size: 1.125rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-left: 4px solid #696cff;
    }

    fieldset.module h2:before {
        content: 'üìã';
        font-size: 1.25rem;
    }

    .form-row {
        padding: 1.5rem !important;
        background: #f8f9fa !important;
        margin-bottom: 1.25rem !important;
        border-radius: 0.5rem !important;
        border-left: 4px solid #696cff !important;
        transition: all 0.3s ease !important;
    }

    .form-row:hover {
        background: #e9ecef !important;
        border-left-color: #764ba2 !important;
        transform: translateX(5px);
    }

    .form-row.errors {
        border-left-color: #ff4c51 !important;
        background: #fff5f5 !important;
    }

    .form-row label,
    .form-row > div > label {
        display: inline-block !important;
        font-weight: 600 !important;
        color: #566a7f !important;
        font-size: 0.9375rem !important;
        margin-bottom: 0.5rem !important;
    }

    .form-row.field-email label:after,
    .form-row.field-firstname label:after,
    .form-row.field-lastname label:after,
    .form-row.field-password1 label:after,
    .form-row.field-password2 label:after,
    .form-row.field-role label:after {
        content: " *" !important;
        color: #ff4c51 !important;
        font-size: 1.125rem !important;
        font-weight: bold !important;
    }

    .form-row label.required:after {
        content: " *" !important;
        color: #ff4c51 !important;
        font-size: 1.125rem !important;
        font-weight: bold !important;
    }

    .form-row .asteriskField,
    .form-row .required {
        color: #ff4c51 !important;
        font-size: 1.125rem !important;
        font-weight: bold !important;
    }

    input[type="text"],
    input[type="password"],
    input[type="email"],
    input[type="number"],
    input[type="tel"],
    input[type="url"],
    select,
    textarea {
        width: 100% !important;
        padding: 0.75rem 1rem !important;
        border: 2px solid #d9dee3 !important;
        border-radius: 0.5rem !important;
        font-size: 0.9375rem !important;
        transition: all 0.3s ease !important;
        background: white !important;
        color: #566a7f !important;
        font-family: inherit !important;
    }

    input:focus,
    select:focus,
    textarea:focus {
        border-color: #696cff !important;
        outline: none !important;
        box-shadow: 0 0 0 0.2rem rgba(105, 108, 255, 0.15) !important;
        background: white !important;
    }

    .form-row.errors input[type="text"],
    .form-row.errors input[type="password"],
    .form-row.errors input[type="email"],
    .form-row.errors input[type="number"],
    .form-row.errors input[type="tel"],
    .form-row.errors input[type="url"],
    .form-row.errors select,
    .form-row.errors textarea {
        border-color: #ff4c51 !important;
        background: #fff5f5 !important;
    }

    .form-row.errors input:focus,
    .form-row.errors select:focus,
    .form-row.errors textarea:focus {
        border-color: #ff4c51 !important;
        box-shadow: 0 0 0 0.2rem rgba(255, 76, 81, 0.25) !important;
    }

    textarea {
        min-height: 120px;
        resize: vertical;
    }

    input[type="checkbox"] {
        width: 1.25rem;
        height: 1.25rem;
        cursor: pointer;
        margin-right: 0.5rem;
        accent-color: #696cff;
    }

    input[type="radio"] {
        width: 1.125rem;
        height: 1.125rem;
        cursor: pointer;
        margin-right: 0.5rem;
        accent-color: #696cff;
    }

    .help,
    .helptext,
    p.help {
        color: #a1acb8 !important;
        font-size: 0.8125rem !important;
        font-style: italic !important;
        margin-top: 0.375rem !important;
        display: block !important;
        line-height: 1.5 !important;
    }

    ul.errorlist {
        background: #ffe0db !important;
        border-left: 4px solid #ff4c51 !important;
        padding: 0.75rem 1rem !important;
        margin: 0.5rem 0 0 0 !important;
        border-radius: 0.375rem !important;
        list-style: none !important;
        display: block !important;
    }

    ul.errorlist li {
        color: #ff4c51 !important;
        font-weight: 600 !important;
        font-size: 0.875rem !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
        margin: 0 !important;
        padding: 0.25rem 0 !important;
        list-style: none !important;
    }

    ul.errorlist li:before {
        content: '‚ö†' !important;
        font-size: 1rem !important;
        flex-shrink: 0;
    }

    .errornote,
    p.errornote {
        background: #ffe0db !important;
        border-left: 4px solid #ff4c51 !important;
        padding: 1rem 1.25rem !important;
        margin: 0 0 1.5rem 0 !important;
        border-radius: 0.5rem !important;
        color: #ff4c51 !important;
        font-weight: 600 !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
    }

    .errornote:before,
    p.errornote:before {
        content: '‚ö†' !important;
        font-size: 1.25rem !important;
    }

    .form-row .errors,
    .form-row span.errors {
        color: #ff4c51 !important;
        font-weight: 600 !important;
        font-size: 0.875rem !important;
        display: block !important;
        margin-top: 0.5rem !important;
    }

    .submit-row {
        background: #f8f9fa;
        padding: 1.5rem 2rem;
        border-radius: 0 0 0.5rem 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        border-top: 1px solid #e7e7ff;
    }

    input[type="submit"],
    .submit-row input[type="submit"],
    button[type="submit"] {
        padding: 0.875rem 2rem !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        border: none !important;
        border-radius: 0.5rem !important;
        font-weight: 600 !important;
        font-size: 0.9375rem !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 4px 12px rgba(105, 108, 255, 0.3) !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
    }

    input[type="submit"]:hover,
    button[type="submit"]:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 20px rgba(105, 108, 255, 0.4) !important;
    }

    input[type="submit"]:active,
    button[type="submit"]:active {
        transform: translateY(0) !important;
    }

    .cancel-link {
        color: #a1acb8 !important;
        text-decoration: none !important;
        padding: 0.875rem 1.5rem !important;
        border-radius: 0.5rem !important;
        transition: all 0.3s ease !important;
        font-weight: 500 !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
    }

    .cancel-link:hover {
        background: #e9ecef !important;
        color: #566a7f !important;
    }

    .inline-group {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e7e7ff;
    }

    input[type="file"] {
        padding: 0.5rem !important;
        background: #f8f9fa !important;
        border: 2px dashed #d9dee3 !important;
        border-radius: 0.5rem !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
    }

    input[type="file"]:hover {
        border-color: #696cff !important;
        background: #e9ecef !important;
    }

    .selector {
        border: 2px solid #d9dee3 !important;
        border-radius: 0.5rem !important;
        overflow: hidden !important;
        background: white !important;
    }

    .selector select {
        border: none !important;
        background: white !important;
    }

    .selector-chosen select {
        background: #f8f9fa !important;
    }

    .selector h2 {
        background: #696cff !important;
        color: white !important;
        padding: 0.75rem 1rem !important;
        margin: 0 !important;
        font-size: 0.875rem !important;
    }

    .success {
        background: #d4f4dd !important;
        border-left: 4px solid #28c76f !important;
        padding: 1rem 1.25rem !important;
        margin: 1.5rem 0 !important;
        border-radius: 0.5rem !important;
        color: #1e7e34 !important;
        font-weight: 500 !important;
    }

    @media (max-width: 768px) {
        .layout-page {
            margin-left: 0.5rem;
            margin-right: 0.5rem;
        }

        .form-header {
            padding: 1.5rem;
        }

        .form-header h2 {
            font-size: 1.5rem;
        }

        .form-content {
            padding: 1.5rem;
        }

        .form-row {
            padding: 1rem !important;
        }

        .submit-row {
            flex-direction: column;
            padding: 1rem 1.5rem;
        }

        input[type="submit"],
        .cancel-link {
            width: 100%;
            justify-content: center;
        }
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .required-fields-note {
        background: #fff3cd !important;
        border-left: 4px solid #ffc107 !important;
        padding: 0.75rem 1rem !important;
        margin-bottom: 1.5rem !important;
        border-radius: 0.375rem !important;
        color: #856404 !important;
        font-size: 0.875rem !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
    }

    .required-fields-note:before {
        content: '‚Ñπ' !important;
        font-size: 1.125rem !important;
        font-weight: bold !important;
    }

    .password-strength {
        margin-top: 0.5rem;
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
    }

    .password-strength-bar {
        height: 100%;
        transition: all 0.3s ease;
    }

    .password-strength-text {
        margin-top: 0.35rem;
        font-size: 0.8rem;
        font-weight: 600;
        color: #a1acb8;
    }

    .password-strength-text.weak {
        color: #ff4c51;
    }
    .password-strength-text.medium {
        color: #ffc107;
    }
    .password-strength-text.strong {
        color: #28c76f;
    }

    /* container pour l'ic√¥ne ≈ìil */
    .password-field-container {
        position: relative;
    }

    .toggle-password {
        position: absolute;
        right: 0.9rem;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        font-size: 1.2rem;
        color: #a1acb8;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .toggle-password:hover {
        color: #696cff;
    }
</style>
{% endblock %}

{% block content %}
<div class="layout-wrapper layout-content-navbar">
  <div class="layout-container">

    {% include "layout/partials/menu/vertical/vertical_menu.html" %}

    <div class="layout-page">

      {% include "layout/partials/navbar/navbar.html" %}

      <div class="content-wrapper">
        <div class="content-inner">

          <div class="page-header">
            <h4>
              <span style="color: #a1acb8;">Administration / Utilisateurs /</span> 
              {% if original %}
                Modifier l'utilisateur
              {% else %}
                Ajouter un utilisateur
              {% endif %}
            </h4>
            <p>
              {% if original %}
                Modifiez les informations de l'utilisateur ci-dessous
              {% else %}
                Remplissez le formulaire pour cr√©er un nouveau compte utilisateur
              {% endif %}
            </p>
          </div>

          <div class="form-container">
            
            <div class="form-header">
              <h2>
                <i class='bx {% if original %}bx-user-circle{% else %}bx-user-plus{% endif %}'></i>
                {% if original %}
                  Modifier : {{ original }}
                {% else %}
                  Nouvel Utilisateur
                {% endif %}
              </h2>
              <p>
                {% if original %}
                  Mettez √† jour les informations de l'utilisateur
                {% else %}
                  Compl√©tez tous les champs requis pour cr√©er un nouveau compte
                {% endif %}
              </p>
            </div>

            <div class="form-content">

              <div class="required-fields-note">
                Les champs marqu√©s d'un <span style="color: #ff4c51;">*</span> sont obligatoires
              </div>

              {% if adminform.non_field_errors %}
                {% for error in adminform.non_field_errors %}
                  <p class="errornote">{{ error }}</p>
                {% endfor %}
              {% elif adminform.errors or inline_admin_formsets.errors %}
                <p class="errornote">Veuillez corriger les erreurs ci-dessous.</p>
              {% endif %}

              <form method="post" enctype="multipart/form-data" id="user_form">
                {% csrf_token %}

                {% block field_sets %}
                  {% for fieldset in adminform %}
                    {% include "admin/includes/fieldset.html" %}
                  {% endfor %}
                {% endblock %}

                {% block inline_field_sets %}
                  {% for inline_admin_formset in inline_admin_formsets %}
                    {% include inline_admin_formset.opts.template %}
                  {% endfor %}
                {% endblock %}

                <div class="submit-row">
                  <div>
                    <button type="submit" name="_addanother" style="background: #03c3ec;">
                      <i class='bx bx-plus'></i>
                      Enregistrer et ajouter un autre
                    </button>
                    <button type="submit" name="_continue" style="background: #28c76f;">
                      <i class='bx bx-edit'></i>
                      Enregistrer et continuer
                    </button>
                  </div>
                  <div>
                    <a href="{% url 'admin:userApp_user_changelist' %}" class="cancel-link">
                      <i class='bx bx-arrow-back'></i>
                      Retour √† la liste
                    </a>
                    {% if original %}
                    <a href="{% url 'admin:userApp_user_delete' original.pk %}" 
                       class="cancel-link" 
                       style="color: #ff4c51;"
                       onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer cet utilisateur ?');">
                      <i class='bx bx-trash'></i>
                      Supprimer
                    </a>
                    {% endif %}
                  </div>
                </div>

              </form>

            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // ====== AUTO-FOCUS SUR LE PREMIER CHAMP ======
    const firstInput = document.querySelector('.form-row input:not([type="hidden"])');
    if (firstInput) {
        firstInput.focus();
    }

    const form = document.getElementById('user_form');

    // ====== HELPERS ERREURS CLIENT ======
    function clearClientErrors(field) {
        const row = field.closest('.form-row');
        if (!row) return;
        row.classList.remove('errors');
        const existing = row.querySelector('.client-error');
        if (existing) existing.remove();
    }

    function showClientError(field, message) {
        const row = field.closest('.form-row');
        if (!row) return;
        row.classList.add('errors');
        clearClientErrors(field);
        const err = document.createElement('div');
        err.className = 'client-error';
        err.textContent = message;
        err.style.color = '#ff4c51';
        err.style.fontSize = '0.85rem';
        err.style.marginTop = '0.35rem';
        err.style.fontWeight = '600';
        row.appendChild(err);
    }

    // ====== VALIDATION MOT DE PASSE EN TYPANT + NIVEAU ======
    function evaluatePasswordStrength(password) {
        let strength = 0;
        if (password.length >= 8) strength++;
        if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
        if (password.match(/\d/)) strength++;
        if (password.match(/[^a-zA-Z\d]/)) strength++;
        return strength;
    }

    function isPasswordValid(password) {
        if (password.length < 8) return false;
        if (!/[0-9]/.test(password)) return false;
        if (!/[A-Z]/.test(password)) return false;
        if (!/[a-z]/.test(password)) return false;
        return true;
    }

    function attachPasswordUX() {
        const pwd1 = document.querySelector('input[name="password1"]');
        const pwd2 = document.querySelector('input[name="password2"]');

        [pwd1, pwd2].forEach((field) => {
            if (!field) return;

            // container relatif pour l'ic√¥ne
            const parent = field.parentElement;
            parent.classList.add('password-field-container');

            // barre + texte
            const strengthDiv = document.createElement('div');
            strengthDiv.className = 'password-strength';
            strengthDiv.innerHTML = '<div class="password-strength-bar"></div>';
            parent.appendChild(strengthDiv);

            const strengthBar = strengthDiv.querySelector('.password-strength-bar');
            const strengthText = document.createElement('div');
            strengthText.className = 'password-strength-text';
            strengthText.textContent = 'Au moins 8 caract√®res, une majuscule, une minuscule, un chiffre.';
            parent.appendChild(strengthText);

            // ic√¥ne ≈ìil
            const toggle = document.createElement('span');
            toggle.className = 'toggle-password';
            toggle.innerHTML = "<i class='bx bx-show'></i>";
            parent.appendChild(toggle);

            let visible = false;
            toggle.addEventListener('click', () => {
                visible = !visible;
                field.type = visible ? 'text' : 'password';
                toggle.innerHTML = visible ? "<i class='bx bx-hide'></i>" : "<i class='bx bx-show'></i>";
            });

            // mise √† jour de la force en tapant
            field.addEventListener('input', () => {
                const pwd = field.value;
                const strength = evaluatePasswordStrength(pwd);

                strengthBar.className = 'password-strength-bar';
                strengthText.className = 'password-strength-text';

                if (!pwd) {
                    strengthBar.style.width = '0';
                    strengthText.textContent = 'Au moins 8 caract√®res, une majuscule, une minuscule, un chiffre.';
                    return;
                }

                if (strength <= 1) {
                    strengthBar.style.width = '33%';
                    strengthBar.style.background = '#ff4c51';
                    strengthText.textContent = 'Mot de passe faible';
                    strengthText.classList.add('weak');
                } else if (strength <= 3) {
                    strengthBar.style.width = '66%';
                    strengthBar.style.background = '#ffc107';
                    strengthText.textContent = 'Mot de passe moyen';
                    strengthText.classList.add('medium');
                } else {
                    strengthBar.style.width = '100%';
                    strengthBar.style.background = '#28c76f';
                    strengthText.textContent = 'Mot de passe fort';
                    strengthText.classList.add('strong');
                }
            });

            // blocage du blur si invalide
            field.addEventListener('blur', (e) => {
                clearClientErrors(field);
                const value = (field.value || '').trim();

                if (!value) {
                    showClientError(field, 'Ce champ est obligatoire.');
                    // refocus pour emp√™cher de "quitter" tant que vide
                    setTimeout(() => field.focus(), 0);
                    return;
                }

                if (field.name === 'password1' && !isPasswordValid(value)) {
                    showClientError(field, 'Mot de passe non valide : 8 caract√®res min, majuscule, minuscule et chiffre obligatoires.');
                    setTimeout(() => field.focus(), 0);
                    return;
                }

                if (field.name === 'password2') {
                    const pwd1Val = pwd1 ? (pwd1.value || '').trim() : '';
                    if (pwd1Val && value !== pwd1Val) {
                        showClientError(field, 'Les mots de passe ne correspondent pas.');
                        setTimeout(() => field.focus(), 0);
                        return;
                    }
                }
            });
        });
    }

    // ====== VALIDATION LIVE POUR TOUS LES CHAMPS REQUIS ======
    function attachFieldValidation() {
        if (!form) return;
        const requiredInputs = form.querySelectorAll('input[required], select[required], textarea[required]');

        requiredInputs.forEach(input => {
            // √©viter de doubler avec le traitement sp√©cifique des mots de passe
            if (input.name === 'password1' || input.name === 'password2') return;

            input.addEventListener('blur', () => {
                clearClientErrors(input);
                const value = (input.value || '').trim();

                if (!value) {
                    showClientError(input, 'Ce champ est obligatoire.');
                    return;
                }

                if (input.name === 'email') {
                    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!re.test(value)) {
                        showClientError(input, "Veuillez saisir un email valide.");
                    }
                }
            });
        });
    }

    // ====== D√âTECTION MODIFICATIONS POUR AVERTIR AVANT QUITTER ======
    if (form) {
        let formChanged = false;
        const allInputs = form.querySelectorAll('input, select, textarea');
        allInputs.forEach(input => {
            input.addEventListener('change', () => {
                formChanged = true;
            });
        });
        
        window.addEventListener('beforeunload', (e) => {
            if (formChanged) {
                e.preventDefault();
                e.returnValue = 'Vous avez des modifications non enregistr√©es. Voulez-vous vraiment quitter ?';
            }
        });
        
        form.addEventListener('submit', () => {
            formChanged = false;
        });
    }

    attachPasswordUX();
    attachFieldValidation();
});
</script>
{% endblock %}
