{% extends "admin/change_form.html" %}
{% load static i18n %}

{% block content_title %}
{% endblock %}

{% block extrahead %}
{{ block.super }}

<link rel="stylesheet" href="{% static 'vendor/css/core.css' %}">
<link rel="stylesheet" href="{% static 'vendor/css/theme-default.css' %}">
<link rel="stylesheet" href="{% static 'css/demo.css' %}">
<link rel="stylesheet" href="{% static 'vendor/libs/perfect-scrollbar/perfect-scrollbar.css' %}">
<link rel="stylesheet" href="{% static 'vendor/fonts/boxicons.css' %}">

<style>
    #header,
    #nav-sidebar,
    .breadcrumbs,
    #toggle-nav-sidebar {
        display: none !important;
    }

    body {
        margin: 0 !important;
        padding: 0 !important;
        background: #f5f5f9;
        font-family: 'Public Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    #content {
        margin: 0 !important;
        padding: 0 !important;
    }

    .layout-wrapper {
        display: flex;
        min-height: 100vh;
        width: 100%;
    }

    .layout-container {
        display: flex;
        flex: 1;
    }

    .layout-page {
        display: flex;
        flex-direction: column;
        flex: 1;
        margin-left: 1.5rem;
        margin-right: 1.5rem;
    }

    .content-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 2rem 0;
    }

    .content-inner {
        max-width: 1440px;
        width: 100%;
        margin: 0 auto;
        padding: 0 1rem;
    }

    .page-header {
        margin-bottom: 2rem;
    }

    .page-header h4 {
        font-weight: 600;
        color: #566a7f;
        margin-bottom: 0.5rem;
        font-size: 1.5rem;
    }

    .page-header p {
        color: #a1acb8;
        margin: 0;
        font-size: 0.9375rem;
    }

    .form-container {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 6px rgba(67, 89, 113, 0.12);
        overflow: hidden;
        animation: slideIn 0.4s ease;
    }

    .form-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2rem;
        color: white;
    }

    .form-header h2 {
        margin: 0 0 0.5rem 0;
        font-size: 1.75rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .form-header h2 i {
        font-size: 2rem;
    }

    .form-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 0.9375rem;
    }

    .form-content {
        padding: 2rem;
    }

    .form-content > h1,
    .form-content > .breadcrumbs {
        display: none !important;
    }

    fieldset.module {
        background: transparent;
        border: none;
        padding: 0;
        margin-bottom: 2rem;
    }

    fieldset.module h2 {
        background: #f8f9fa;
        color: #566a7f;
        padding: 1rem 1.25rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        font-size: 1.125rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-left: 4px solid #696cff;
    }

    fieldset.module h2:before {
        content: 'üìã';
        font-size: 1.25rem;
    }

    .form-row {
        padding: 1.5rem !important;
        background: #f8f9fa !important;
        margin-bottom: 1.25rem !important;
        border-radius: 0.5rem !important;
        border-left: 4px solid #696cff !important;
        transition: all 0.3s ease !important;
    }

    .form-row:hover {
        background: #e9ecef !important;
        border-left-color: #764ba2 !important;
        transform: translateX(5px);
    }

    .form-row.errors {
        border-left-color: #ff4c51 !important;
        background: #fff5f5 !important;
    }

    .form-row label,
    .form-row > div > label {
        display: inline-block !important;
        font-weight: 600 !important;
        color: #566a7f !important;
        font-size: 0.9375rem !important;
        margin-bottom: 0.5rem !important;
    }

    /* Ast√©risque champs obligatoires principaux */
    .form-row.field-email label:after,
    .form-row.field-firstname label:after,
    .form-row.field-lastname label:after,
    .form-row.field-role label:after {
        content: " *" !important;
        color: #ff4c51 !important;
        font-size: 1.125rem !important;
        font-weight: bold !important;
    }

    .form-row label.required:after {
        content: " *" !important;
        color: #ff4c51 !important;
        font-size: 1.125rem !important;
        font-weight: bold !important;
    }

    .form-row .asteriskField,
    .form-row .required {
        color: #ff4c51 !important;
        font-size: 1.125rem !important;
        font-weight: bold !important;
    }

    input[type="text"],
    input[type="email"],
    input[type="number"],
    input[type="tel"],
    input[type="url"],
    select,
    textarea {
        width: 100% !important;
        padding: 0.75rem 1rem !important;
        border: 2px solid #d9dee3 !important;
        border-radius: 0.5rem !important;
        font-size: 0.9375rem !important;
        transition: all 0.3s ease !important;
        background: white !important;
        color: #566a7f !important;
        font-family: inherit !important;
    }

    input:focus,
    select:focus,
    textarea:focus {
        border-color: #696cff !important;
        outline: none !important;
        box-shadow: 0 0 0 0.2rem rgba(105, 108, 255, 0.15) !important;
        background: white !important;
    }

    .form-row.errors input[type="text"],
    .form-row.errors input[type="email"],
    .form-row.errors select,
    .form-row.errors textarea {
        border-color: #ff4c51 !important;
        background: #fff5f5 !important;
    }

    .form-row.errors input:focus,
    .form-row.errors select:focus,
    .form-row.errors textarea:focus {
        border-color: #ff4c51 !important;
        box-shadow: 0 0 0 0.2rem rgba(255, 76, 81, 0.25) !important;
    }

    textarea {
        min-height: 120px;
        resize: vertical;
    }

    .help,
    .helptext,
    p.help {
        color: #a1acb8 !important;
        font-size: 0.8125rem !important;
        font-style: italic !important;
        margin-top: 0.375rem !important;
        display: block !important;
        line-height: 1.5 !important;
    }

    ul.errorlist {
        background: #ffe0db !important;
        border-left: 4px solid #ff4c51 !important;
        padding: 0.75rem 1rem !important;
        margin: 0.5rem 0 0 0 !important;
        border-radius: 0.375rem !important;
        list-style: none !important;
        display: block !important;
    }

    ul.errorlist li {
        color: #ff4c51 !important;
        font-weight: 600 !important;
        font-size: 0.875rem !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
        margin: 0 !important;
        padding: 0.25rem 0 !important;
        list-style: none !important;
    }

    ul.errorlist li:before {
        content: '‚ö†' !important;
        font-size: 1rem !important;
        flex-shrink: 0;
    }

    .errornote,
    p.errornote {
        background: #ffe0db !important;
        border-left: 4px solid #ff4c51 !important;
        padding: 1rem 1.25rem !important;
        margin: 0 0 1.5rem 0 !important;
        border-radius: 0.5rem !important;
        color: #ff4c51 !important;
        font-weight: 600 !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
    }

    .errornote:before,
    p.errornote:before {
        content: '‚ö†' !important;
        font-size: 1.25rem !important;
    }

    .form-row .errors,
    .form-row span.errors {
        color: #ff4c51 !important;
        font-weight: 600 !important;
        font-size: 0.875rem !important;
        display: block !important;
        margin-top: 0.5rem !important;
    }

    .submit-row {
        background: #f8f9fa;
        padding: 1.5rem 2rem;
        border-radius: 0 0 0.5rem 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        border-top: 1px solid #e7e7ff;
    }

    input[type="submit"],
    .submit-row input[type="submit"],
    button[type="submit"] {
        padding: 0.875rem 2rem !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        border: none !important;
        border-radius: 0.5rem !important;
        font-weight: 600 !important;
        font-size: 0.9375rem !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 4px 12px rgba(105, 108, 255, 0.3) !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
    }

    input[type="submit"]:hover,
    button[type="submit"]:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 20px rgba(105, 108, 255, 0.4) !important;
    }

    input[type="submit"]:active,
    button[type="submit"]:active {
        transform: translateY(0) !important;
    }

    .cancel-link {
        color: #a1acb8 !important;
        text-decoration: none !important;
        padding: 0.875rem 1.5rem !important;
        border-radius: 0.5rem !important;
        transition: all 0.3s ease !important;
        font-weight: 500 !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
    }

    .cancel-link:hover {
        background: #e9ecef !important;
        color: #566a7f !important;
    }

    .inline-group {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e7e7ff;
    }

    .success {
        background: #d4f4dd !important;
        border-left: 4px solid #28c76f !important;
        padding: 1rem 1.25rem !important;
        margin: 1.5rem 0 !important;
        border-radius: 0.5rem !important;
        color: #1e7e34 !important;
        font-weight: 500 !important;
    }

    @media (max-width: 768px) {
        .layout-page {
            margin-left: 0.5rem;
            margin-right: 0.5rem;
        }

        .form-header {
            padding: 1.5rem;
        }

        .form-header h2 {
            font-size: 1.5rem;
        }

        .form-content {
            padding: 1.5rem;
        }

        .form-row {
            padding: 1rem !important;
        }

        .submit-row {
            flex-direction: column;
            padding: 1rem 1.5rem;
        }

        input[type="submit"],
        .cancel-link {
            width: 100%;
            justify-content: center;
        }
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .required-fields-note {
        background: #fff3cd !important;
        border-left: 4px solid #ffc107 !important;
        padding: 0.75rem 1rem !important;
        margin-bottom: 1.5rem !important;
        border-radius: 0.375rem !important;
        color: #856404 !important;
        font-size: 0.875rem !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
    }

    .required-fields-note:before {
        content: '‚Ñπ' !important;
        font-size: 1.125rem !important;
        font-weight: bold !important;
    }

</style>
{% endblock %}

{% block content %}
<div class="layout-wrapper layout-content-navbar">
  <div class="layout-container">

    {% include "layout/partials/menu/vertical/vertical_menu.html" %}

    <div class="layout-page">

      {% include "layout/partials/navbar/navbar.html" %}

      <div class="content-wrapper">
        <div class="content-inner">

          <div class="page-header">
            <h4>
              <span style="color: #a1acb8;">Administration / Utilisateurs /</span> 
              Modifier l'utilisateur
            </h4>
            <p>
              Mettez √† jour les informations de l'utilisateur ci-dessous
            </p>
          </div>

          <div class="form-container">
            
            <div class="form-header">
              <h2>
                <i class='bx bx-user-circle'></i>
                Modifier : {{ original }}
              </h2>
              <p>
                Ajustez les donn√©es du compte utilisateur, ou utilisez le lien de changement de mot de passe si n√©cessaire.
              </p>
            </div>

            <div class="form-content">

              <div class="required-fields-note">
                Les champs marqu√©s d'un <span style="color: #ff4c51;">*</span> sont obligatoires
              </div>

              {% if adminform.non_field_errors %}
                {% for error in adminform.non_field_errors %}
                  <p class="errornote">{{ error }}</p>
                {% endfor %}
              {% elif adminform.errors or inline_admin_formsets.errors %}
                <p class="errornote">Veuillez corriger les erreurs ci-dessous.</p>
              {% endif %}

              <form method="post" enctype="multipart/form-data" id="user_form">
                {% csrf_token %}

                {% block field_sets %}
                  {% for fieldset in adminform %}
                    {% include "admin/includes/fieldset.html" %}
                  {% endfor %}
                {% endblock %}

                {% block inline_field_sets %}
                  {% for inline_admin_formset in inline_admin_formsets %}
                    {% include inline_admin_formset.opts.template %}
                  {% endfor %}
                {% endblock %}

                <div class="submit-row">
                  <div>
                    <button type="submit" name="_save" style="background: #28c76f;">
                      <i class='bx bx-save'></i>
                      Enregistrer les modifications
                    </button>
                    <button type="submit" name="_continue" style="background: #03c3ec;">
                      <i class='bx bx-edit'></i>
                      Enregistrer et continuer l‚Äô√©dition
                    </button>
                  </div>
                  <div>
                    <a href="{% url 'admin:userApp_user_changelist' %}" class="cancel-link">
                      <i class='bx bx-arrow-back'></i>
                      Retour √† la liste
                    </a>
                    <a href="{% url 'admin:userApp_user_delete' original.pk %}" 
                       class="cancel-link" 
                       style="color: #ff4c51;"
                       onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer cet utilisateur ?');">
                      <i class='bx bx-trash'></i>
                      Supprimer
                    </a>
                  </div>
                </div>

              </form>

            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('user_form');

    // Auto-focus
    const firstInput = document.querySelector('.form-row input:not([type="hidden"])');
    if (firstInput) {
        firstInput.focus();
    }

    // Helpers erreurs client
    function clearClientErrors(field) {
        const row = field.closest('.form-row');
        if (!row) return;
        row.classList.remove('errors');
        const existing = row.querySelector('.client-error');
        if (existing) existing.remove();
    }

    function showClientError(field, message) {
        const row = field.closest('.form-row');
        if (!row) return;
        row.classList.add('errors');
        clearClientErrors(field);
        const err = document.createElement('div');
        err.className = 'client-error';
        err.textContent = message;
        err.style.color = '#ff4c51';
        err.style.fontSize = '0.85rem';
        err.style.marginTop = '0.35rem';
        err.style.fontWeight = '600';
        row.appendChild(err);
    }

    // Validation live pour les champs requis
    if (form) {
        const requiredNames = ['email', 'firstname', 'lastname', 'role'];
        const inputs = requiredNames
            .map(name => form.querySelector(`[name="${name}"]`))
            .filter(Boolean);

        inputs.forEach(input => {
            input.setAttribute('required', 'required');

            input.addEventListener('blur', () => {
                clearClientErrors(input);
                const value = (input.value || '').trim();

                if (!value) {
                    showClientError(input, 'Ce champ est obligatoire.');
                    return;
                }

                if (input.name === 'email') {
                    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!re.test(value)) {
                        showClientError(input, "Veuillez saisir un email valide.");
                    }
                }
            });
        });

        // Alerte avant de quitter si le formulaire a chang√©
        let formChanged = false;
        const allInputs = form.querySelectorAll('input, select, textarea');
        allInputs.forEach(input => {
            input.addEventListener('change', () => {
                formChanged = true;
            });
        });
        
        window.addEventListener('beforeunload', (e) => {
            if (formChanged) {
                e.preventDefault();
                e.returnValue = 'Vous avez des modifications non enregistr√©es. Voulez-vous vraiment quitter ?';
            }
        });
        
        form.addEventListener('submit', () => {
            formChanged = false;
        });
    }
});
</script>
{% endblock %}
